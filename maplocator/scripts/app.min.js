/*global angular */

(function () {
  "use strict";

  angular.module('app', ['firebase', 'angular.safeapply', 'google-maps']).
    config(['$routeProvider', function($routeProvider) {
      $routeProvider.
        when('/', {controller: 'MapsIndexController', templateUrl: '/views/maps/index.html'}).
        when('/map/:mapId', {controller: 'MapsEditController', templateUrl: '/views/maps/edit.html'}).
        otherwise({redirectTo: '/'});
    }]);
}());


/* **********************************************
     Begin users.js
********************************************** */

/*global Firebase, FirebaseAuthClient, angular, console */

(function() {

  "use strict";

  var app = angular.module('app');

  app.factory('User', function() {
    var self = {};
    self.loggedIn = false;
    self.auth = {};
    return self;
  });

  app.controller('UserController', ['$scope', 'User',
    function($scope, User) {

      $scope.email = '';
      $scope.password = '';

      $scope.user = User;
      $scope.state = 'loading';

      var db = new Firebase('https://maplocator.firebaseio.com/');

      var authClient = new FirebaseAuthClient(db, function(error, user) {
        if (error) {
          console.log(error);
        } else if (user) {
          $scope.safeApply(function() {
            $scope.user.auth = user;
            $scope.user.loggedIn = true;
            $scope.state = 'authorized';
          });
        } else {
          $scope.safeApply(function() {
            $scope.state = 'anonymous';
          });
        }
      });

      $scope.login = function() {
        authClient.login('password', {
          rememberMe: true,
          email: $scope.email,
          password: $scope.password
        });
      };

      $scope.logout = function() {
        authClient.logout();
        window.location.reload();
      };
    }
  ]);
}());


/* **********************************************
     Begin db.js
********************************************** */

/*global angular, Firebase */

(function() {

  "use strict";

  var app = angular.module('app');

  app.factory('DB', ['$rootScope', 'User', '$q', 'angularFire', function($rootScope, User, $q, angularFire) {
    var self = {};

    var db = new Firebase('https://maplocator.firebaseio.com/');

    self.randomName = function() {
      return db.push().name();
    };

    self.ready = function($scope, key, paths, example) {
      var deferred = $q.defer();

      var ref = null;

      var unwatchFn = $rootScope.$watch(function() {
        return User.loggedIn;
      }, function() {
        if (User.loggedIn) {
          ref = new Firebase('https://maplocator.firebaseio.com/users/').child(User.auth.id);
          ([].concat(paths)).forEach(function(path) { ref = ref.child(path); });
          deferred.resolve(angularFire(ref, $scope, key, example));
          unwatchFn();
        }
      });

      return deferred.promise;
    };

    return self;
  }]);

}());


/* **********************************************
     Begin maps.js
********************************************** */

/*global angular */

(function() {

  "use strict";

  var app = angular.module('app');

  app.controller('MapsIndexController', ['$scope', 'DB', 'User',
    function($scope, DB, User) {

      $scope.user = User;
      $scope.maps = [];

      DB.ready($scope, 'maps', 'maps', []);

      $scope.addMap = function() {
        $scope.maps.push({name: $scope.mapName, description: $scope.mapDescription, id: DB.randomName()});
        $scope.mapName = '';
        $scope.mapDescription = '';
      };

      $scope.removeMap = function(id) {
        $scope.maps.splice(id, 1);
      };

      $scope.db = DB;

      window.s = $scope;

    }
  ]);

  app.controller('MapsEditController', ['$scope', 'DB', 'User', '$routeParams',
    function($scope, DB, User, $routeParams) {
      angular.extend($scope, {
        center: {
          latitude: 37.0625,
          longitude: -95.677068
        },
        markers: [],
        zoom: 8
      });

      $scope.user = User;
      $scope.map = {};

      DB.ready($scope, 'map', ['maps', $routeParams.mapId], {});

      $scope.addPin = function() {
        $scope.map.pins.push({name: $scope.pinName, description: $scope.pinDescription, id: DB.randomName()});
        $scope.pinName = '';
        $scope.pinDescription = '';
      };

      $scope.removePin = function(id) {
        $scope.map.pins.splice(id, 1);
      };
    }
  ]);
}());


/* **********************************************
     Begin pins.js
********************************************** */

/*global angular */

(function() {

  "use strict";

  var app = angular.module('app');

  app.controller('PinsIndexController', ['$scope', 'DB', 'User', '$routeParams',
    function($scope, DB, User, $routeParams) {
      angular.extend($scope, {
        center: {
          latitude: 37.0625,
          longitude: -95.677068
        },
        markers: [],
        zoom: 8
      });

      $scope.user = User;
      $scope.map = {};

      DB.ready($scope, 'map', ['maps', $routeParams.mapId], {});

      $scope.addPin = function() {
        $scope.map.pins.push({name: $scope.pinName, description: $scope.pinDescription, id: DB.randomName()});
        $scope.pinName = '';
        $scope.pinDescription = '';
      };

      $scope.removePin = function(id) {
        $scope.map.pins.splice(id, 1);
      };
    }
  ]);
}());
